---
import Base from '../layouts/Base.astro';
import Navbar from '../components/Navbar.tsx';
import Footer from '../components/Footer.astro';
---

<Base title="Acceso Operadores | Digital Level">
  <Navbar client:load />

  <main class="relative pt-32 pb-20 bg-[#0b0e11] overflow-hidden">
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[500px] h-[500px] bg-[#F3BA2F]/5 rounded-full blur-[120px] pointer-events-none"></div>

    <div class="flex items-center justify-center min-h-[60vh] px-6 relative z-10">
      <div class="w-full max-w-md bg-[#161a1e]/80 backdrop-blur-xl border border-gray-800 p-8 rounded-3xl shadow-[0_20px_50px_rgba(0,0,0,0.5)]">
        
        <div class="text-center mb-8">
          <div class="inline-flex p-3 rounded-2xl bg-[#F3BA2F]/10 mb-4 border border-[#F3BA2F]/20">
            <img src="/img/logo.png" alt="Digital Level Logo" class="w-12 h-12 object-contain" />
          </div>
          <h2 class="text-3xl font-black text-white tracking-tighter uppercase">
            PANEL <span class="text-[#F3BA2F]">OPERADOR</span>
          </h2>
          <p class="text-gray-400 text-sm mt-2 font-medium uppercase tracking-widest">Digital Level Systems</p>
        </div>

        <form id="loginForm" class="space-y-5">
          <div id="error-container" class="hidden bg-red-500/10 border border-red-500/20 text-red-500 text-[10px] font-bold uppercase p-3 rounded-xl text-center tracking-widest mb-4">
          </div>
          
          <div>
            <label class="block text-[10px] font-black uppercase tracking-[0.2em] text-[#F3BA2F] mb-2 ml-1">Usuario Operador</label>
            <input 
              type="text" 
              name="user" 
              id="user"
              required 
              placeholder="Ej: admin"
              class="w-full bg-[#0b0e11] border border-gray-700 rounded-2xl p-4 text-white focus:border-[#F3BA2F] focus:ring-1 focus:ring-[#F3BA2F] transition-all outline-none placeholder:text-gray-600"
            />
          </div>
          <div>
            <label class="block text-[10px] font-black uppercase tracking-[0.2em] text-[#F3BA2F] mb-2 ml-1">PIN de Seguridad</label>
            <input 
              type="password" 
              name="password" 
              id="password"
              required 
              inputmode="numeric"
              placeholder="••••••••"
              class="w-full bg-[#0b0e11] border border-gray-800 rounded-2xl p-4 text-white focus:border-[#F3BA2F] focus:ring-1 focus:ring-[#F3BA2F] transition-all outline-none"
            />
          </div>

          <div class="pt-2">
            <button 
              type="submit" 
              id="submitBtn"
              class="w-full bg-[#F3BA2F] hover:bg-[#ffdb4d] text-black font-black py-4 rounded-2xl transition-all transform hover:scale-[1.02] shadow-[0_10px_20px_rgba(243,186,47,0.15)] active:scale-95 uppercase text-sm tracking-widest"
            >
              Acceder al Sistema
            </button>
          </div>
        </form>

        <p class="text-center mt-8 text-[10px] text-gray-500 uppercase font-bold tracking-widest">
            Protocolo de Seguridad <span class="text-white">AES-256 (Sentinel Node)</span>
        </p>
      </div>
    </div>
  </main>

  
</Base>

<script>
  const loginForm = document.getElementById('loginForm') as HTMLFormElement;
  const errorContainer = document.getElementById('error-container');
  const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;

  loginForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    submitBtn.disabled = true;
    submitBtn.innerText = "VERIFICANDO...";
    
    if (errorContainer) errorContainer.classList.add('hidden');

    const formData = new FormData(loginForm);
    const alias = formData.get('user');
    const pin = formData.get('password');

    try {
      // LLAMADA AL PUERTO 3003 (Portal de Operadores)
      // UPDATED TO LOCALHOST FOR DEV
      const apiUrl = window.location.hostname === 'localhost' 
        ? "http://localhost:3003/api/auth/login" 
        : "/api/auth/login";

      const response = await fetch(apiUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ alias, pin }) // El motor espera 'alias' y 'pin'
      });

      const result = await response.json();

      if (response.ok && result.success) {
        // Almacenamos el token para autorizar las siguientes vistas
        // Persistencia en localStorage (para peticiones cliente)
        localStorage.setItem('session_token', result.token);
        localStorage.setItem('auth_token', result.token);
        
        // --- MULTI-ROL (OPERADOR / INVERSOR) ---
        const role = result.role || 'operator'; // Fallback legacy
        const user = role === 'investor' ? result.investor : (result.operator || {});
        
        localStorage.setItem('user_role', role);
        localStorage.setItem('user_info', JSON.stringify(user));
        
        // Compatibilidad Legacy
        if (user.alias) {
          localStorage.setItem('operator_alias', user.alias);
        }

        // Base de la API (puerto 3003 del VPS)
        // Update API Base as well based on environment
        const apiBase = window.location.hostname === 'localhost'
            ? 'http://localhost:3003'
            : window.location.origin;
        localStorage.setItem('api_base', apiBase);

        // Persistencia en cookie (para middleware de Astro)
        const maxAgeDays = 7;
        const maxAge = maxAgeDays * 24 * 60 * 60; // 7 días
        document.cookie = `session_token=${result.token}; Path=/; Max-Age=${maxAge}; SameSite=Lax`;
        
        if (role === 'investor') {
            window.location.href = "/investor";
        } else {
            window.location.href = "/dashboard";
        }
      } else {
        if (errorContainer) {
          errorContainer.innerText = result.error || "Credenciales inválidas";
          errorContainer.classList.remove('hidden');
        }
        submitBtn.disabled = false;
        submitBtn.innerText = "ACCEDER AL SISTEMA";
      }
    } catch (error) {
      if (errorContainer) {
        errorContainer.innerText = "Error: El motor Sentinel no responde en el puerto 3003 (Local o Remoto).";
        errorContainer.classList.remove('hidden');
      }
      submitBtn.disabled = false;
      submitBtn.innerText = "ACCEDER AL SISTEMA";
    }
  });
</script>