---
import Base from '../layouts/Base.astro';
import Navbar from '../components/Navbar.tsx';
import Footer from '../components/Footer.astro';
---

<Base title="Acceso Operadores | Digital Level">
  <Navbar client:load />

  <main class="relative pt-24 sm:pt-32 pb-14 sm:pb-20 bg-[#0b0e11] overflow-hidden">
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[320px] h-[320px] sm:w-[500px] sm:h-[500px] bg-[#F3BA2F]/5 rounded-full blur-[120px] pointer-events-none"></div>

    <div class="flex items-center justify-center min-h-[60vh] px-4 sm:px-6 relative z-10">
      <div class="w-full max-w-md bg-[#161a1e]/80 backdrop-blur-xl border border-gray-800 p-5 sm:p-8 rounded-2xl sm:rounded-3xl shadow-[0_20px_50px_rgba(0,0,0,0.5)]">
        
        <div class="text-center mb-8">
          <div class="inline-flex p-2.5 sm:p-3 rounded-2xl bg-[#F3BA2F]/10 mb-4 border border-[#F3BA2F]/20">
            <img src="/img/logo.png" alt="Digital Level Logo" class="w-10 h-10 sm:w-12 sm:h-12 object-contain" />
          </div>
          <h2 class="text-2xl sm:text-3xl font-black text-white tracking-tighter uppercase leading-tight">
            DigitaLevel<span class="text-[#F3BA2F]"> Ecosystem</span>
          </h2>
          <p class="text-gray-400 text-xs sm:text-sm mt-2 font-medium uppercase tracking-[0.12em] sm:tracking-widest">Unified Management Hub</p>
        </div>

        <form id="loginForm" class="space-y-5">
          <div id="error-container" class="hidden bg-red-500/10 border border-red-500/20 text-red-500 text-[10px] font-bold uppercase p-3 rounded-xl text-center tracking-widest mb-4">
          </div>
          
          <div>
            <label class="block text-[10px] font-black uppercase tracking-[0.2em] text-[#F3BA2F] mb-2 ml-1">Usuario</label>
            <input 
              type="text" 
              name="user" 
              id="user"
              required 
              placeholder="Ej: admin"
              class="w-full bg-[#0b0e11] border border-gray-700 rounded-2xl p-3.5 sm:p-4 text-white focus:border-[#F3BA2F] focus:ring-1 focus:ring-[#F3BA2F] transition-all outline-none placeholder:text-gray-600"
            />
          </div>
          <div>
            <label class="block text-[10px] font-black uppercase tracking-[0.2em] text-[#F3BA2F] mb-2 ml-1">PIN de Seguridad</label>
            <input 
              type="password" 
              name="password" 
              id="password"
              required 
              inputmode="numeric"
              placeholder="••••••••"
              class="w-full bg-[#0b0e11] border border-gray-800 rounded-2xl p-3.5 sm:p-4 text-white focus:border-[#F3BA2F] focus:ring-1 focus:ring-[#F3BA2F] transition-all outline-none"
            />
          </div>

          <div class="pt-2">
            <button 
              type="submit" 
              id="submitBtn"
              class="w-full bg-[#F3BA2F] hover:bg-[#ffdb4d] text-black font-black py-3.5 sm:py-4 rounded-2xl transition-all transform hover:scale-[1.02] shadow-[0_10px_20px_rgba(243,186,47,0.15)] active:scale-95 uppercase text-xs sm:text-sm tracking-[0.15em] sm:tracking-widest"
            >
              Acceder al Sistema
            </button>
          </div>
        </form>

        <p class="text-center mt-7 sm:mt-8 text-[9px] sm:text-[10px] text-gray-500 uppercase font-bold tracking-[0.12em] sm:tracking-widest">
            Protocolo de Seguridad <span class="text-white">AES-256 (Sentinel Node)</span>
        </p>
      </div>
    </div>
  </main>

  
</Base>

<script>
  const LOCAL_LOGIN_TIMEOUT_MS = 8000;
  const PRIMARY_LOGIN_TIMEOUT_MS = 45000;
  const FALLBACK_LOGIN_TIMEOUT_MS = 20000;
  const DEFAULT_SUBMIT_TEXT = "ACCEDER AL SISTEMA";
  const VERIFYING_TEXT = "VERIFICANDO...";

  const loginForm = document.getElementById('loginForm') as HTMLFormElement;
  const errorContainer = document.getElementById('error-container');
  const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;

  function setSubmitState(disabled: boolean, text: string) {
    if (!submitBtn) return;
    submitBtn.disabled = disabled;
    submitBtn.innerText = text;
  }

  async function fetchWithTimeout(url: string, init: RequestInit, timeoutMs: number): Promise<Response> {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

    try {
      return await fetch(url, { ...init, signal: controller.signal });
    } finally {
      clearTimeout(timeoutId);
    }
  }

  async function parseJsonSafe(response: Response): Promise<any> {
    try {
      return await response.json();
    } catch {
      return null;
    }
  }

  function isRetryableStatus(status: number): boolean {
    return status >= 500 || status === 404 || status === 429;
  }

  async function attemptLoginCandidate(
    candidate: { url: string; timeoutMs: number },
    requestInit: RequestInit
  ): Promise<{ response: Response; result: any }> {
    const response = await fetchWithTimeout(candidate.url, requestInit, candidate.timeoutMs);
    const result = await parseJsonSafe(response);

    if (isRetryableStatus(response.status)) {
      const err: any = new Error(`retryable_status_${response.status}`);
      err.response = response;
      err.result = result;
      throw err;
    }

    return { response, result };
  }

  loginForm?.addEventListener('submit', async (e) => {
    e.preventDefault();

    setSubmitState(true, VERIFYING_TEXT);
    if (errorContainer) errorContainer.classList.add('hidden');

    const formData = new FormData(loginForm);
    const alias = String(formData.get('user') || '').trim();
    const pin = String(formData.get('password') || '').trim();

    if (!alias || !pin) {
      if (errorContainer) {
        errorContainer.innerText = "Debes ingresar usuario y PIN.";
        errorContainer.classList.remove('hidden');
      }
      setSubmitState(false, DEFAULT_SUBMIT_TEXT);
      return;
    }

    try {
      const host = window.location.hostname.toLowerCase();
      const isLocal = host === 'localhost' || host === '127.0.0.1';
      const sameOriginApi = "/api/auth/login";
      const sameOriginPortalApi = "/portal/api/auth/login";
      const alternateOrigin =
        host === "www.digitalevel.com"
          ? `${window.location.protocol}//digitalevel.com`
          : host === "digitalevel.com"
            ? `${window.location.protocol}//www.digitalevel.com`
            : "";
      const apiCandidates = isLocal
        ? [{ url: "http://localhost:3003/api/auth/login", timeoutMs: LOCAL_LOGIN_TIMEOUT_MS }]
        : [
            { url: sameOriginApi, timeoutMs: PRIMARY_LOGIN_TIMEOUT_MS },
            { url: sameOriginPortalApi, timeoutMs: PRIMARY_LOGIN_TIMEOUT_MS },
            ...(alternateOrigin
              ? [
                  { url: `${alternateOrigin}/api/auth/login`, timeoutMs: FALLBACK_LOGIN_TIMEOUT_MS },
                  { url: `${alternateOrigin}/portal/api/auth/login`, timeoutMs: FALLBACK_LOGIN_TIMEOUT_MS }
                ]
              : [])
          ];

      const requestInit: RequestInit = {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ alias, pin })
      };

      let response: Response | null = null;
      let result: any = null;
      let lastError: unknown = null;

      for (let i = 0; i < apiCandidates.length; i++) {
        const candidate = apiCandidates[i];
        try {
          const attempt = await attemptLoginCandidate(candidate, requestInit);
          response = attempt.response;
          result = attempt.result;
          break;
        } catch (error: any) {
          if (error?.response) {
            response = error.response;
            result = error.result ?? null;
            const hasNextCandidate = i < apiCandidates.length - 1;
            if (!hasNextCandidate) break;
            continue;
          }
          lastError = error;
        }
      }

      if (!response) {
        throw lastError || new Error("No se pudo conectar con la API de login");
      }

      if (response.ok && result?.success) {
        if (result.role === 'admin') {
          const protocol = window.location.protocol;
          const hostname = window.location.hostname;
          const authToken = btoa(`${alias}:${pin}`);
          const adminUrl = `${protocol}//${hostname}/admin/?authtoken=${authToken}`;
          setSubmitState(true, "REDIRIGIENDO A ADMIN...");
          window.location.href = adminUrl;
          return;
        }

        localStorage.setItem('session_token', result.token);
        localStorage.setItem('auth_token', result.token);

        const role = result.role || 'operator';
        const user = role === 'investor' ? result.investor : (result.operator || {});
        localStorage.setItem('user_role', role);
        localStorage.setItem('user_info', JSON.stringify(user));

        if (user.alias) {
          localStorage.setItem('operator_alias', user.alias);
        }

        const apiBase = isLocal ? 'http://localhost:3003' : window.location.origin;
        localStorage.setItem('api_base', apiBase);

        const maxAgeDays = 7;
        const maxAge = maxAgeDays * 24 * 60 * 60;
        document.cookie = `session_token=${result.token}; Path=/; Max-Age=${maxAge}; SameSite=Lax`;

        window.location.href = role === 'investor' ? "/investor" : "/dashboard";
        return;
      }

      if (errorContainer) {
        errorContainer.innerText = result?.error || "Credenciales invalidas";
        errorContainer.classList.remove('hidden');
      }
      setSubmitState(false, DEFAULT_SUBMIT_TEXT);
    } catch (error: any) {
      const isTimeout = error?.name === 'AbortError';
      if (errorContainer) {
        errorContainer.innerText = isTimeout
          ? "Tiempo de espera agotado verificando login. Intenta de nuevo."
          : "Error: El motor Sentinel no responde (proxy/API).";
        errorContainer.classList.remove('hidden');
      }
      setSubmitState(false, DEFAULT_SUBMIT_TEXT);
    }
  });
</script>
