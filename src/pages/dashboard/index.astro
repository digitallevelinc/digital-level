---
// src/pages/dashboard/index.astro (o la ruta correspondiente)
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import StatCard from '../../components/dashboard/StatCard.astro';

// Importación de componentes modulares de logística
import P2P from '../../components/dashboard/p2p.astro';
import Pay from '../../components/dashboard/pay.astro';
import Red from '../../components/dashboard/red.astro';
import Switch from '../../components/dashboard/switch.astro';

const banks = [
  { name: 'Mercantil', color: 'border-l-blue-600' },
  { name: 'Banesco', color: 'border-l-green-600' },
  { name: 'BNC', color: 'border-l-orange-500' },
  { name: 'Provincial', color: 'border-l-blue-900' },
  { name: 'Pago Movil', color: 'border-l-yellow-500' },
  { name: 'Bancamiga', color: 'border-l-green-800' }
];
---

<DashboardLayout>
  <div class="flex justify-between items-center mb-6 px-2">
    <div>
      <h1 class="text-white font-black text-xl uppercase tracking-tighter">
        Bienvenido, <span id="operator-alias" class="text-[#F3BA2F]">Cargando...</span>
      </h1>
      <p id="last-update" class="text-[9px] text-gray-500 uppercase font-bold tracking-widest mt-1 italic">Sincronizando con Sentinel...</p>
      <p id="kpi-filter-label" class="text-[9px] text-gray-500 uppercase font-bold tracking-widest mt-1">Rango activo: Hoy</p>
    </div>
    <button id="logout-btn" class="bg-red-500/10 hover:bg-red-500/20 text-red-500 text-[10px] font-black py-2 px-4 rounded-xl border border-red-500/20 transition-all uppercase tracking-widest">
      Cerrar Sesión
    </button>
  </div>

  <section class="mb-8 bg-gradient-to-br from-[#0f1216] to-[#0b0d11] border border-gray-800 rounded-2xl p-4 shadow-lg shadow-black/20">
    <div class="flex items-center justify-between flex-wrap gap-2 mb-3">
      <div class="flex items-center gap-2">
        <span class="w-1 h-4 bg-[#F3BA2F]"></span>
        <p class="text-[10px] font-black uppercase tracking-[0.25em] text-gray-400">Filtro temporal KPI</p>
      </div>
      <p class="text-[10px] text-gray-600">Selecciona un rango rápido o personaliza fechas.</p>
    </div>

    <div class="flex flex-wrap gap-2 mb-4" id="kpi-preset-group">
      <button class="kpi-preset-btn px-3 py-2 rounded-xl text-xs font-bold uppercase tracking-wide border border-gray-800 bg-white/5 hover:border-[#F3BA2F]/60" data-preset="today">Hoy</button>
      <button class="kpi-preset-btn px-3 py-2 rounded-xl text-xs font-bold uppercase tracking-wide border border-gray-800 bg-white/5 hover:border-[#F3BA2F]/60" data-preset="this_week">Esta semana</button>
      <button class="kpi-preset-btn px-3 py-2 rounded-xl text-xs font-bold uppercase tracking-wide border border-gray-800 bg-white/5 hover:border-[#F3BA2F]/60" data-preset="last_7">Últimos 7 días</button>
      <button class="kpi-preset-btn px-3 py-2 rounded-xl text-xs font-bold uppercase tracking-wide border border-gray-800 bg-white/5 hover:border-[#F3BA2F]/60" data-preset="this_month">Mes actual</button>
      <button class="kpi-preset-btn px-3 py-2 rounded-xl text-xs font-bold uppercase tracking-wide border border-gray-800 bg-white/5 hover:border-[#F3BA2F]/60" data-preset="last_30">Últimos 30 días</button>
      <button class="kpi-preset-btn px-3 py-2 rounded-xl text-xs font-bold uppercase tracking-wide border border-gray-800 bg-white/5 hover:border-[#F3BA2F]/60" data-preset="ytd">YTD</button>
      <button class="kpi-preset-btn px-3 py-2 rounded-xl text-xs font-bold uppercase tracking-wide border border-gray-800 bg-white/5 hover:border-[#F3BA2F]/60" data-preset="all">Todo</button>
      <button class="kpi-preset-btn px-3 py-2 rounded-xl text-xs font-bold uppercase tracking-wide border border-gray-800 bg-white/5 hover:border-[#F3BA2F]/60" data-preset="custom">Personalizado</button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
      <div>
        <label class="text-[9px] font-black text-gray-500 uppercase mb-1 block">Desde</label>
        <input id="kpi-date-from" type="date" class="bg-black text-white text-xs border border-gray-700 p-3 rounded-xl w-full outline-none focus:border-[#F3BA2F]/70" />
      </div>
      <div>
        <label class="text-[9px] font-black text-gray-500 uppercase mb-1 block">Hasta</label>
        <input id="kpi-date-to" type="date" class="bg-black text-white text-xs border border-gray-700 p-3 rounded-xl w-full outline-none focus:border-[#F3BA2F]/70" />
      </div>
      <div class="flex items-end gap-2">
        <button id="kpi-apply-range" class="bg-[#F3BA2F] text-black text-[11px] font-black py-3 px-4 rounded-xl w-full uppercase tracking-wide hover:bg-[#d9a927] transition-all">Aplicar filtro</button>
      </div>
    </div>
  </section>

  <section class="mb-8">
    <h2 class="text-[#F3BA2F] text-[10px] font-black uppercase tracking-[0.2em] mb-4 italic flex items-center gap-2">
      <span class="w-1 h-3 bg-[#F3BA2F]"></span> 1. MÉTRICAS DE RENDIMIENTO CRÍTICO
    </h2>
    <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
      <div id="kpi-balance"><StatCard title="Balance Real Total" value="---" subValue="Suma total carteras" icon="fas fa-vault" /></div>
      <div id="kpi-breakeven"><StatCard title="Tasa Mínima Compra" value="---" type="warning" subValue="Break-even" icon="fas fa-shield-halved" /></div>
      <div id="kpi-margin"><StatCard title="Margen Global %" value="---" subValue="Beneficio neto" icon="fas fa-chart-line" /></div>
      <div id="kpi-profit"><StatCard title="Profit Total" value="---" subValue="Ganancia acumulada" icon="fas fa-coins" /></div>
      <div id="kpi-cycle"><StatCard title="Ganancia por Ciclo" value="---" type="success" subValue="Rendimiento actual" icon="fas fa-sync" /></div>
    </div>
  </section>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <section>
      <h2 class="text-gray-500 text-[10px] font-black uppercase tracking-[0.2em] mb-4 italic">2. CONTROL DE OPERACIONES Y VOLUMEN</h2>
      <div class="grid grid-cols-2 gap-3">
        <div id="ops-count"><StatCard title="Cantidad de Operaciones" value="---" subValue="Total ejecutadas" /></div>
        <div id="ops-rates"><StatCard title="Tasas Globales PP" value="---" subValue="Compra / Venta" /></div>
        <div id="ops-buys"><StatCard title="Compras Totales" value="---" subValue="Cargando..." /></div>
        <div id="ops-sells"><StatCard title="Ventas Totales" value="---" subValue="Cargando..." /></div>
        <div id="ops-fees"><StatCard title="Comisiones Totales" value="---" subValue="Costos operativos" /></div>
      </div>
    </section>

    <section>
      <h2 class="text-gray-500 text-[10px] font-black uppercase tracking-[0.2em] mb-4 italic">4. PROYECCIONES E INSIGHTS</h2>
      <div class="grid grid-cols-2 gap-3">
        <div id="proj-daily"><StatCard title="Ganancia Diaria" value="---" type="success" subValue="Últimas 24h" /></div>
        <div id="proj-vol"><StatCard title="Volumen Proyectado" value="---" subValue="Meta estimada" /></div>
        <StatCard title="Comisión Operador" value="60%" subValue="Configurado" />
        <div class="bg-[#161a1e] border border-gray-800 rounded-xl p-3 flex flex-col justify-center">
          <label class="text-[9px] font-bold text-gray-500 uppercase mb-2">Filtro Proyección Temporal</label>
          <select class="bg-black text-white text-xs border border-gray-700 p-2 rounded outline-none">
            <option>1 Día</option><option>1 Semana</option><option>15 Días</option><option>1 Mes</option>
          </select>
        </div>
      </div>
    </section>
  </div>

  <section class="mb-8">
    <h2 class="text-gray-500 text-[10px] font-black uppercase tracking-[0.2em] mb-4 italic">3. LOGÍSTICA DE CARTERAS (BALANCES INTERNOS)</h2>
    <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
      
      <P2P />
      <Pay />
      <Red />
      <Switch />
      
      <div id="wallet-fiat">
        <StatCard title="Balance Fiat" value="---" subValue="Efectivo en bancos" />
      </div>
    </div>
  </section>

  <section class="pb-20">
    <h2 class="text-gray-500 text-[10px] font-black uppercase tracking-[0.2em] mb-4 italic">5. PANEL DE BANCOS (CONTROL DE VOLUMEN)</h2>
    <div class="bg-[#161a1e] border border-gray-800 rounded-xl overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-left text-[9px] border-collapse">
          <thead class="bg-black/40 text-gray-500 uppercase font-black border-b border-gray-800">
            <tr>
              <th class="px-3 py-4 text-white italic">Bancos Operando</th>
              <th class="px-3 py-4 text-center">Balance FIAT</th>
              <th class="px-3 py-4 text-center">Tasa Compra PP</th>
              <th class="px-3 py-4 text-center">Tasa Venta PP</th>
              <th class="px-3 py-4 text-center">Margen %</th>
              <th class="px-3 py-4 text-center text-[#F3BA2F]">Profit USDT ≈</th>
            </tr>
          </thead>
          <tbody id="bank-table-body" class="divide-y divide-gray-800/50">
            {banks.map(b => (
              <tr class={`hover:bg-white/[0.02] border-l-4 ${b.color}`}>
                <td class="px-3 py-4 font-bold text-white">{b.name}</td>
                <td colspan="5" class="px-3 py-4 text-center text-gray-600 animate-pulse italic">Esperando datos de Sentinel...</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <script>
    // Importamos la lógica orquestadora desde el nuevo script modular
    import { initDashboard } from '../../scripts/dashboard.js';
    initDashboard();
  </script>
</DashboardLayout>