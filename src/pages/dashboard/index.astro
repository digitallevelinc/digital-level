---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import StatCard from '../../components/dashboard/StatCard.astro';

const banks = [
  { name: 'Mercantil', color: 'border-l-blue-600' },
  { name: 'Banesco', color: 'border-l-green-600' },
  { name: 'BNC', color: 'border-l-orange-500' },
  { name: 'Provincial', color: 'border-l-blue-900' },
  { name: 'Pago Movil', color: 'border-l-yellow-500' },
  { name: 'Bancamiga', color: 'border-l-green-800' }
];
---

<DashboardLayout>
  <div class="flex justify-between items-center mb-6 px-2">
    <div>
      <h1 class="text-white font-black text-xl uppercase tracking-tighter">
        Bienvenido, <span id="operator-alias" class="text-[#F3BA2F]">Cargando...</span>
      </h1>
      <p id="last-update" class="text-[9px] text-gray-500 uppercase font-bold tracking-widest mt-1 italic">Sincronizando con Sentinel...</p>
    </div>
    <button id="logout-btn" class="bg-red-500/10 hover:bg-red-500/20 text-red-500 text-[10px] font-black py-2 px-4 rounded-xl border border-red-500/20 transition-all uppercase tracking-widest">
      Cerrar Sesión
    </button>
  </div>

  <section class="mb-8">
    <h2 class="text-[#F3BA2F] text-[10px] font-black uppercase tracking-[0.2em] mb-4 italic flex items-center gap-2">
      <span class="w-1 h-3 bg-[#F3BA2F]"></span> 1. MÉTRICAS DE RENDIMIENTO CRÍTICO
    </h2>
    <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
      <div id="kpi-balance"><StatCard title="Balance Real Total" value="$15,240.50" subValue="Suma total carteras" icon="fas fa-vault" /></div>
      <div id="kpi-breakeven"><StatCard title="Tasa Mínima Compra" value="613.04 VES" type="warning" subValue="Break-even" icon="fas fa-shield-halved" /></div>
      <div id="kpi-margin"><StatCard title="Margen Global %" value="1.25%" subValue="Beneficio neto" icon="fas fa-chart-line" /></div>
      <div id="kpi-profit"><StatCard title="Profit Total" value="$2,450.00" subValue="Ganancia acumulada" icon="fas fa-coins" /></div>
      <div id="kpi-cycle"><StatCard title="Ganancia por Ciclo" value="$45.20" type="success" subValue="Rendimiento actual" icon="fas fa-sync" /></div>
    </div>
  </section>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <section>
      <h2 class="text-gray-500 text-[10px] font-black uppercase tracking-[0.2em] mb-4 italic">2. CONTROL DE OPERACIONES Y VOLUMEN</h2>
      <div class="grid grid-cols-2 gap-3">
        <div id="ops-count"><StatCard title="Cantidad de Operaciones" value="154" subValue="Total ejecutadas" /></div>
        <div id="ops-rates"><StatCard title="Tasas Globales PP" value="612.50 / 618.20" subValue="Compra / Venta" /></div>
        <div id="ops-buys"><StatCard title="Compras Totales" value="78 Órdenes" subValue="$7,500.00 Acumulado" /></div>
        <div id="ops-sells"><StatCard title="Ventas Totales" value="76 Órdenes" subValue="$7,745.00 Acumulado" /></div>
        <div id="ops-fees"><StatCard title="Comisiones Totales" value="$12.40" subValue="Costos operativos" /></div>
      </div>
    </section>

    <section>
      <h2 class="text-gray-500 text-[10px] font-black uppercase tracking-[0.2em] mb-4 italic">4. PROYECCIONES E INSIGHTS</h2>
      <div class="grid grid-cols-2 gap-3">
        <div id="proj-daily"><StatCard title="Ganancia Diaria" value="+$124.39" type="success" subValue="Últimas 24h" /></div>
        <div id="proj-vol"><StatCard title="Volumen Proyectado" value="$3,500.00" subValue="Meta estimada" /></div>
        <StatCard title="Comisión Operador" value="60% (Cesar)" subValue="Pago configurado" />
        <div class="bg-[#161a1e] border border-gray-800 rounded-xl p-3 flex flex-col justify-center">
          <label class="text-[9px] font-bold text-gray-500 uppercase mb-2">Filtro Proyección Temporal</label>
          <select class="bg-black text-white text-xs border border-gray-700 p-2 rounded outline-none">
            <option>1 Día</option><option>1 Semana</option><option>15 Días</option><option>1 Mes</option>
          </select>
        </div>
      </div>
    </section>
  </div>

  <section class="mb-8">
    <h2 class="text-gray-500 text-[10px] font-black uppercase tracking-[0.2em] mb-4 italic">3. LOGÍSTICA DE CARTERAS (BALANCES INTERNOS)</h2>
    <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
      <div id="wallet-p2p"><StatCard title="Balance P2P" value="$5,400" /></div>
      <div id="wallet-switch"><StatCard title="Balance Switch" value="$2,100" /></div>
      <div id="wallet-red"><StatCard title="Balance Red" value="$1,250" /></div>
      <div id="wallet-pay"><StatCard title="Balance Pay" value="$450" /></div>
      <div id="wallet-fiat"><StatCard title="Balance Fiat" value="85,000 VES" /></div>
    </div>
  </section>

  <section class="pb-20">
    <h2 class="text-gray-500 text-[10px] font-black uppercase tracking-[0.2em] mb-4 italic">5. PANEL DE BANCOS (CONTROL DE VOLUMEN)</h2>
    <div class="bg-[#161a1e] border border-gray-800 rounded-xl overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-left text-[9px] border-collapse">
          <thead class="bg-black/40 text-gray-500 uppercase font-black border-b border-gray-800">
            <tr>
              <th class="px-3 py-4 text-white italic">Bancos Operando</th>
              <th class="px-3 py-4 text-center">Balance FIAT</th>
              <th class="px-3 py-4 text-center">Tasa Compra PP</th>
              <th class="px-3 py-4 text-center">Tasa Venta PP</th>
              <th class="px-3 py-4 text-center">Margen %</th>
              <th class="px-3 py-4 text-center text-[#F3BA2F]">Profit USDT ≈</th>
            </tr>
          </thead>
          <tbody id="bank-table-body" class="divide-y divide-gray-800/50">
            {banks.map(b => (
              <tr class={`hover:bg-white/[0.02] border-l-4 ${b.color}`}>
                <td class="px-3 py-4 font-bold text-white">{b.name}</td>
                <td colspan="5" class="px-3 py-4 text-center text-gray-600 animate-pulse italic italic">Esperando datos de Sentinel...</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  </section>
</DashboardLayout>

<script>
  const API_BASE = "http://144.91.110.204:3003";
  const token = localStorage.getItem('session_token');
  const alias = localStorage.getItem('operator_alias');

  // FORMATEADORES
  const fUSDT = (v) => `$${Number(v || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
  const fVES = (v) => `${Number(v || 0).toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} VES`;

  async function updateDashboard() {
    if (!token) return;

    try {
      const [kpiRes, statsRes] = await Promise.all([
        fetch(`${API_BASE}/api/kpis`, { headers: { 'Authorization': `Bearer ${token}` } }),
        fetch(`${API_BASE}/api/stats`, { headers: { 'Authorization': `Bearer ${token}` } })
      ]);

      const kpis = await kpiRes.json();
      const stats = await statsRes.json();

      // 1. Cabecera
      document.getElementById('operator-alias').textContent = alias || kpis.operatorAlias;
      document.getElementById('last-update').textContent = `ACTUALIZADO: ${new Date().toLocaleTimeString()} (SENTINEL LIVE)`;

      // 2. Función de inyección segura (no rompe el card)
      const inject = (id, value, isProfit = false) => {
        const el = document.querySelector(`#${id} h3`) || document.querySelector(`#${id} .text-white`) || document.querySelector(`#${id} span`);
        if (el && value !== undefined) {
          el.textContent = value;
          if (isProfit) {
            const num = parseFloat(String(value).replace(/[^0-9.-]+/g,""));
            el.style.color = num >= 0 ? "#10b981" : "#ef4444";
          }
        }
      };

      // SECCIÓN 1: CRÍTICOS
      inject('kpi-balance', fUSDT(stats.currentBalance || kpis.critical.balanceTotal));
      inject('kpi-breakeven', fVES(kpis.critical.breakEvenRate));
      inject('kpi-margin', `${kpis.critical.globalMarginPercent.toFixed(2)}%`);
      inject('kpi-profit', fUSDT(kpis.critical.profitTotalUSDT), true);
      inject('kpi-cycle', fUSDT(kpis.critical.currentCycleProfit), true);

      // SECCIÓN 2: OPERACIONES
      inject('ops-count', kpis.operations.totalOperations);
      inject('ops-rates', `${fVES(kpis.operations.weightedAvgBuyRate)} / ${fVES(kpis.operations.weightedAvgSellRate)}`);
      inject('ops-buys', `${kpis.operations.buys.count} Órdenes`);
      inject('ops-sells', `${kpis.operations.sells.count} Órdenes`);
      inject('ops-fees', fUSDT(kpis.operations.totalFeesPaid));

      // SECCIÓN 3: CARTERAS
      inject('wallet-p2p', fUSDT(kpis.wallets.balanceP2P));
      inject('wallet-switch', fUSDT(kpis.wallets.balanceSwitch));
      inject('wallet-red', fUSDT(kpis.wallets.balanceRed));
      inject('wallet-pay', fUSDT(kpis.wallets.balancePay));
      inject('wallet-fiat', fVES(kpis.wallets.balanceFiat));

      // SECCIÓN 5: TABLA DE BANCOS
      const tableBody = document.getElementById('bank-table-body');
      if (tableBody && kpis.bankInsights) {
        tableBody.innerHTML = kpis.bankInsights.map(b => `
          <tr class="hover:bg-white/[0.02] border-l-4 border-l-gray-700">
            <td class="px-3 py-4 font-bold text-white">${b.bank}</td>
            <td class="px-3 py-4 text-center font-mono">${fVES(b.fiatBalance)}</td>
            <td class="px-3 py-4 text-center font-mono">${fVES(b.avgBuyRate)}</td>
            <td class="px-3 py-4 text-center font-mono">${fVES(b.avgSellRate)}</td>
            <td class="px-3 py-4 text-center font-mono">${b.margin.toFixed(2)}%</td>
            <td class="px-3 py-4 text-center font-bold" style="color: ${b.profit >= 0 ? '#10b981' : '#ef4444'}">${fUSDT(b.profit)}</td>
          </tr>
        `).join('');
      }

    } catch (err) {
      console.error("Error sincronizando Dashboard:", err);
    }
  }

  // Logout
  document.getElementById('logout-btn')?.addEventListener('click', () => {
    localStorage.clear();
    window.location.href = "/login";
  });

  updateDashboard();
  setInterval(updateDashboard, 30000);
</script>