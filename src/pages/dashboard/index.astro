---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import StatCard from '../../components/dashboard/StatCard.astro';

const banks = [
  { name: 'Mercantil', id: 'bank-mercantil', color: 'border-l-blue-600' },
  { name: 'Banesco', id: 'bank-banesco', color: 'border-l-green-600' },
  { name: 'BNC', id: 'bank-bnc', color: 'border-l-orange-500' },
  { name: 'Provincial', id: 'bank-provincial', color: 'border-l-blue-900' },
  { name: 'Pago Movil', id: 'bank-pagomovil', color: 'border-l-yellow-500' },
  { name: 'Bancamiga', id: 'bank-bancamiga', color: 'border-l-green-800' }
];
---

<DashboardLayout>
  <div class="flex justify-between items-center mb-6 px-2">
    <div>
      <h1 class="text-white font-black text-xl uppercase tracking-tighter">
        Bienvenido, <span id="operator-alias" class="text-[#F3BA2F]">Cargando...</span>
      </h1>
      <p id="last-update" class="text-[9px] text-gray-500 uppercase font-bold tracking-widest mt-1">Sincronizando con Sentinel...</p>
    </div>
    <button id="logout-btn" class="bg-red-500/10 hover:bg-red-500/20 text-red-500 text-[10px] font-black py-2 px-4 rounded-xl border border-red-500/20 transition-all uppercase tracking-widest">
      Cerrar Sesión
    </button>
  </div>

  <section class="mb-8">
    <h2 class="text-[#F3BA2F] text-[10px] font-black uppercase tracking-[0.2em] mb-4 italic flex items-center gap-2">
      <span class="w-1 h-3 bg-[#F3BA2F]"></span> 1. MÉTRICAS DE RENDIMIENTO CRÍTICO
    </h2>
    <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
      <div id="card-balance"><StatCard title="Balance Real Total" value="..." subValue="Cargando..." icon="fas fa-vault" /></div>
      <div id="card-breakeven"><StatCard title="Tasa Mínima Compra" value="..." type="warning" subValue="Break-even" icon="fas fa-shield-halved" /></div>
      <div id="card-margin"><StatCard title="Margen Global %" value="..." subValue="Beneficio neto" icon="fas fa-chart-line" /></div>
      <div id="card-profit"><StatCard title="Profit Total" value="..." subValue="Ganancia acumulada" icon="fas fa-coins" /></div>
      <div id="card-cycle"><StatCard title="Ganancia por Ciclo" value="..." type="success" subValue="Rendimiento actual" icon="fas fa-sync" /></div>
    </div>
  </section>

  </DashboardLayout>

<script>
  // CONFIGURACIÓN DE CONEXIÓN
  const API_BASE = "http://144.91.110.204:3003";
  const token = localStorage.getItem('session_token');
  const alias = localStorage.getItem('operator_alias');

  // FORMATEADORES
  const fUSDT = (v) => `$${Number(v || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
  const fVES = (v) => `${Number(v || 0).toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} VES`;

  async function updateDashboard() {
    if (!token) { window.location.href = "/login"; return; }

    try {
      const [kpiRes, statsRes] = await Promise.all([
        fetch(`${API_BASE}/api/kpis`, { headers: { 'Authorization': `Bearer ${token}` } }),
        fetch(`${API_BASE}/api/stats`, { headers: { 'Authorization': `Bearer ${token}` } })
      ]);

      if (!kpiRes.ok) throw new Error("Sesión expirada");
      
      const kpis = await kpiRes.json();
      const stats = await statsRes.json();

      // 1. Actualizar Textos Básicos
      document.getElementById('operator-alias').textContent = alias || kpis.operatorAlias;
      document.getElementById('last-update').textContent = `ACTUALIZADO: ${new Date().toLocaleTimeString()} (SENTINEL LIVE)`;

      // 2. Inyectar datos en las StatCards (Buscamos el h3 o div de valor dentro del contenedor)
      const updateCard = (id, val) => {
        const el = document.querySelector(`#${id} h3`) || document.querySelector(`#${id} [class*='text-white']`);
        if (el) el.textContent = val;
      };

      // Datos Críticos
      updateCard('card-balance', fUSDT(stats.currentBalance || kpis.critical.balanceTotal));
      updateCard('card-breakeven', fVES(kpis.critical.breakEvenRate));
      updateCard('card-margin', `${kpis.critical.globalMarginPercent.toFixed(2)}%`);
      updateCard('card-profit', fUSDT(kpis.critical.profitTotalUSDT));
      updateCard('card-cycle', fUSDT(kpis.critical.currentCycleProfit || 0));

    } catch (err) {
      console.error("Error sync:", err);
      // Opcional: Redirigir a login si el token falla
    }
  }

  // LOGOUT
  document.getElementById('logout-btn')?.addEventListener('click', () => {
    localStorage.clear();
    window.location.href = "/login";
  });

  // Inicializar y refrescar cada 30 segundos
  updateDashboard();
  setInterval(updateDashboard, 30000);
</script>